{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}留樣管理系統{% endblock %}
{% block css %}
<link rel="stylesheet" href="/static/css/index.css">
<style lang="scss" rel="stylesheet/scss" scoped>
.showColor:hover{
    color: red;
}

.fullScreen{
    position: fixed;
    top:0;
    left:0;
    height:100%;
    width: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 101;
    overflow:hidden;
}

.el-dialog {
    width: 700px;
}

.content{
    width:25px;
    height: 70px;
    position: fixed;
    right: 10px;
    top:60px;
    background-color:#343957;
    color:white;
    font-size: 20px;
    text-align: center;
    margin: 0 auto;
    word-wrap: break-word;
    line-height: 24px;
    writing-mode: vertical-lr;
    z-index: 99;
    opacity: 0.9;
}

#container-yansebiaoshi{
    display:none;
    position: fixed;
    right: 35px;
    top:60px;
    z-index: 99;
    border: 2px solid  #deb887;
}

.el-pagination__total,.el-pagination__jump{
    color:black;
}

.gutter{
    display:block!important;
    width:17px!important;
}

.cell-green{
    background: greenyellow;
}

.tips{
    font-size: 20px;
    font-weight: bold;
    color: coral;
    margin-left: 15px;
}

.el-table .cell {
    box-sizing: border-box;
    white-space: pre-line;
    word-break: break-all;
    line-height: 23px;
}

tbody tr td:last-child {
    text-align: left;
}

.inputError{
    text-align: center;
    color: crimson;
    background-color: beige;
    width: 50%;
    margin: 10px auto 5px;
    position: relative;
}

.inputError,#Customer{
    display:inline-block;
}

.oneLine {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}

.el-table .my-cell {
    vertical-align: top
}

.tableAround{
    padding: 20px;
    -moz-box-shadow: 0px 0px 10px #333333;
    -webkit-box-shadow: 0px 0px 10px #333333;
    box-shadow: 0px 0px 10px #333333;
    border-radius: 10px;
    background-color: rgba(255,255,255,0.1);
}

.admin-only {
    display: none;
}

.is-admin .admin-only {
    display: inline-block;
}

.borrow-btn {
    background-color: #67C23A;
    color: white;
}

.scrap-btn {
    background-color: #F56C6C;
    color: white;
}

.status-warning {
    color: #E6A23C;
}

.status-success {
    color: #67C23A;
}

.status-danger {
    color: #F56C6C;
}

.status-info {
    color: #909399;
}
/* 添加以下CSS到你的style标签中 */
.search-row-container {
    display: flex;
    flex-wrap: nowrap;
    align-items: center;
    overflow-x: auto;
    padding: 10px 0;
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 #f1f1f1;
}

.search-row-container::-webkit-scrollbar {
    height: 6px;
}

.search-row-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.search-row-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.search-row-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.search-item {
    display: flex;
    align-items: center;
    margin-right: 15px;
    min-width: 180px;
    flex-shrink: 0;
}

.search-label {
    color: black;
    font-size: 14px;
    font-weight: bold;
    white-space: nowrap;
    margin-right: 5px;
    flex-shrink: 0;
}

.search-input {
    width: 120px;
}

.button-group {
    display: flex;
    flex-wrap: nowrap;
    align-items: center;
    margin-left: auto;
    flex-shrink: 0;
    padding-left: 20px;
}

.action-button {
    flex-shrink: 0;
    margin-right: 8px;
}

/* 修复表格单元格内容的显示 */
.el-table .cell {
    white-space: nowrap !important;  /* 禁止换行 */
    word-break: keep-all !important; /* 保持单词不换行 */
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

/* 或者更具体的针对数字列 */
.el-table td .status-danger,
.el-table td .status-success,
.el-table td .status-warning {
    white-space: nowrap !important;
    display: inline-block !important;
    min-width: 20px;  /* 设置最小宽度 */
}

/* 针对小屏幕的优化 */
@media screen and (max-width: 1200px) {
    .search-item {
        min-width: 160px;
    }

    .search-input {
        width: 100px;
    }
}

@media screen and (max-width: 992px) {
    .search-item {
        min-width: 150px;
    }

    .search-input {
        width: 90px;
    }
}
</style>
{% endblock %}
{% block content %}
<div id="app">
    <template>
        <el-backtop></el-backtop>
    </template>

    <div class="row" style="white-space: nowrap;">
        <div class="col-md-12">
            <h2 style="text-align: center; color: black;">APDQA留樣管理系統 ${ currentTime }</h2>
        </div>
    </div>

    <!-- 搜索条件区域，根据当前标签页显示不同的搜索条件 -->
    <div class="row" style="margin-bottom: 20px;" v-if="activeTab !== 'myBorrow' && activeTab !== 'myApproval'">
        <div class="col-md-12 search-row-container">
            <!-- 留樣總覽和报废记录共用相同的搜索条件 -->
            <div v-if="activeTab === 'summary' || activeTab === 'scrapRecords'" style="display: flex; flex-wrap: nowrap; align-items: center; flex-shrink: 0;">
                <div class="search-item">
                    <label class="search-label">專案名稱</label>
                    <el-select
                        v-if="activeTab === 'summary'"
                        v-model="searchConditions.summary.project"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.summary.projects"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                    <el-select
                        v-if="activeTab === 'scrapRecords'"
                        v-model="searchConditions.scrapRecords.project"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.scrapRecords.projects"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                </div>

                <div class="search-item">
                    <label class="search-label">樣品名稱</label>
                    <el-select
                        v-if="activeTab === 'summary'"
                        v-model="searchConditions.summary.sample"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.summary.samples"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                    <el-select
                        v-if="activeTab === 'scrapRecords'"
                        v-model="searchConditions.scrapRecords.sample"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.scrapRecords.samples"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                </div>

                <div class="search-item">
                    <label class="search-label">樣品廠商</label>
                    <el-select
                        v-if="activeTab === 'summary'"
                        v-model="searchConditions.summary.manufacturer"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.summary.manufacturers"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                    <el-select
                        v-if="activeTab === 'scrapRecords'"
                        v-model="searchConditions.scrapRecords.manufacturer"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.scrapRecords.manufacturers"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                </div>
            </div>

            <!-- 借還記錄的搜索条件 -->
            <div v-if="activeTab === 'records'" style="display: flex; flex-wrap: nowrap; align-items: center; flex-shrink: 0;">
                <div class="search-item">
                    <label class="search-label">專案名稱</label>
                    <el-select
                        v-model="searchConditions.records.project"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.records.projects"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                </div>

                <div class="search-item">
                    <label class="search-label">樣品名稱</label>
                    <el-select
                        v-model="searchConditions.records.sample"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.records.samples"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                </div>

                <div class="search-item">
                    <label class="search-label">樣品廠商</label>
                    <el-select
                        v-model="searchConditions.records.manufacturer"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.records.manufacturers"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                </div>

                <div class="search-item">
                    <label class="search-label">借用人</label>
                    <el-select
                        v-model="searchConditions.records.borrower"
                        placeholder="選擇或輸入"
                        class="search-input"
                        size="small"
                        filterable
                        clearable
                        @keyup.enter.native="handleSearch">
                        <el-option
                            v-for="item in filterOptions.records.borrowers"
                            :key="item"
                            :label="item"
                            :value="item">
                        </el-option>
                    </el-select>
                </div>
            </div>

            <!-- 按钮区域 -->
            <div class="button-group">
                <template v-if="activeTab !== 'myBorrow' && activeTab !== 'myApproval'">
                    <el-button type="primary" size="small" @click="handleSearch" class="action-button">搜索</el-button>
                    <el-button size="small" @click="handleReset" class="action-button">重置</el-button>
                </template>

                <el-button v-if="activeTab === 'summary'" class="admin-only action-button" type="primary" size="small" @click="showAddDialog" class="action-button">添加</el-button>
                <el-button v-if="activeTab === 'summary'" class="borrow-btn action-button" size="small" @click="showBorrowDialog" :disabled="selectedSamples.length !== 1">借用</el-button>
                <el-button v-if="activeTab === 'summary'" class="scrap-btn admin-only action-button" size="small" @click="showScrapDialog" :disabled="selectedSamples.length !== 1">報廢</el-button>
            </div>
        </div>
    </div>

    <!-- 添加留样对话框 -->
    <!-- 合并后的添加/编辑留样对话框 -->
    <el-dialog :title="isEditMode ? '编辑留樣' : '添加留樣'" width="60%" :visible.sync="addDialogVisible">
        <el-form :model="addForm" label-width="120px" ref="addFormRef" :rules="addFormRules">
            <el-form-item label="專案名稱" prop="Project">
                <el-input v-model="addForm.Project" placeholder="請輸入專案名稱" :disabled="isEditMode"></el-input>
                <span v-if="isEditMode" style="color: #999; font-size: 12px; margin-left: 10px;">(專案名稱不可修改)</span>
            </el-form-item>
            <el-form-item label="專案負責人" prop="Owner">
                <el-select
                    v-model="addForm.Owner"
                    placeholder="請輸入工號或姓名"
                    style="width: 100%;"
                    filterable
                    clearable
                    :filter-method="filterUsers"
                    @change="handleOwnerChange">
                    <el-option
                        v-for="item in filteredUsers"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                    </el-option>
                </el-select>
                <div v-if="selectedOwnerDisplay" style="margin-top: 5px; color: #409EFF; font-size: 12px;">
                    已選擇: ${ selectedOwnerDisplay }
                </div>
            </el-form-item>
            <el-form-item label="樣品名稱" prop="SampleName">
                <el-input v-model="addForm.SampleName" placeholder="請輸入樣品名稱"></el-input>
            </el-form-item>
            <el-form-item label="樣品廠商" prop="Manufacturer">
                <el-input v-model="addForm.Manufacturer" placeholder="請輸入樣品廠商"></el-input>
            </el-form-item>
            <el-form-item label="樣品批次/版本號" prop="SampleBatch">
                <el-input v-model="addForm.SampleBatch" placeholder="請輸入樣品批次/版本號"></el-input>
            </el-form-item>
            <el-form-item label="樣品數量" prop="SampleQuantity">
                <el-input-number v-model="addForm.SampleQuantity" :min="1" style="width: 100%;"></el-input-number>
            </el-form-item>
            <el-form-item label="留樣人" prop="Retainer">
                <el-select
                    v-model="addForm.Retainer"
                    placeholder="請輸入工號或姓名"
                    style="width: 100%;"
                    filterable
                    clearable
                    :filter-method="filterUsers"
                    @change="handleRetainerChange">
                    <el-option
                        v-for="item in filteredUsers"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                    </el-option>
                </el-select>
                <div v-if="selectedRetainerDisplay" style="margin-top: 5px; color: #409EFF; font-size: 12px;">
                    已選擇: ${ selectedRetainerDisplay }
                </div>
            </el-form-item>
            <el-form-item label="留樣日期" prop="RetainStart">
                <el-date-picker
                    v-model="addForm.RetainStart"
                    type="date"
                    value-format="yyyy-MM-dd"
                    placeholder="選擇留樣日期"
                    style="width: 100%;">
                </el-date-picker>
            </el-form-item>
            <el-form-item label="留樣周期(年)" prop="RetainPeriod">
                <el-input-number v-model="addForm.RetainPeriod" :min="0.1" :step="0.1" style="width: 100%;"></el-input-number>
            </el-form-item>
            <el-form-item label="留樣位置" prop="RetainPosition">
                <el-select v-model="addForm.RetainPosition" placeholder="請選擇留樣位置" style="width: 100%;" filterable allow-create>
                    <el-option
                        v-for="item in filterOptions.summary.retain_positions"
                        :key="item"
                        :label="item"
                        :value="item">
                    </el-option>
                </el-select>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="addDialogVisible = false">取消</el-button>
            <el-button type="primary" @click="saveRetainedSample">
                ${ isEditMode ? '保存修改' : '確認添加' }
            </el-button>
        </div>
    </el-dialog>

    <!-- 借用对话框 -->
    <el-dialog title="借用留樣" width="50%" :visible.sync="borrowDialogVisible">
        <el-form :model="borrowForm" label-width="120px">
            <el-form-item label="借用數量">
                <el-input-number v-model="borrowForm.BorrowQuantity" :min="1" :max="selectedSample?.RemainedQuantity || 0"></el-input-number>
                <span style="margin-left: 10px;">最大可借: ${ selectedSample ? selectedSample.RemainedQuantity : 0 }</span>
            </el-form-item>
            <el-form-item label="借用用途">
                <el-radio-group v-model="borrowForm.BorrowedReson">
                    <el-radio label="质量追溯">质量追溯</el-radio>
                    <el-radio label="客户投诉">客户投诉</el-radio>
                    <el-radio label="复检">复检</el-radio>
                    <el-radio label="其他">其他</el-radio>
                </el-radio-group>
                <el-input v-if="borrowForm.BorrowedReson === '其他'" v-model="borrowForm.OtherReason" placeholder="請輸入其他原因" style="margin-top: 10px;"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="borrowDialogVisible = false">取消</el-button>
            <el-button type="primary" @click="borrowSample">確認借用</el-button>
        </div>
    </el-dialog>

    <!-- 报废对话框 -->
    <el-dialog title="報廢留樣" width="50%" :visible.sync="scrapDialogVisible">
        <el-form :model="scrapForm" label-width="120px">
            <el-form-item label="報廢數量">
                <el-input-number v-model="scrapForm.ScrapQuantity" :min="1" :max="selectedSample?.RemainedQuantity || 0"></el-input-number>
            </el-form-item>
            <el-form-item label="報廢原因">
                <el-input type="textarea" v-model="scrapForm.ScrapReason" :rows="3"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="scrapDialogVisible = false">取消</el-button>
            <el-button type="danger" @click="scrapSample">確認報廢</el-button>
        </div>
    </el-dialog>

    <!-- 添加归还对话框（放在其他对话框后面） -->
    <el-dialog :title="returnDialogTitle" width="50%" :visible.sync="returnDialogVisible">
        <el-form :model="returnForm" label-width="120px">
            <el-form-item label="歸還數量">
                <el-input-number
                    v-model="returnForm.ReturnQuantity"
                    :min="1"
                    :max="selectedBorrowRecord?.RemainedQuantity || 0">
                </el-input-number>
                <span style="margin-left: 10px;">最多可還: ${ selectedBorrowRecord ? selectedBorrowRecord.RemainedQuantity : 0 }</span>
            </el-form-item>
            <el-form-item label="歸還原因" prop="ReturnReason">
                <el-input
                    type="textarea"
                    v-model="returnForm.ReturnReason"
                    placeholder="請輸入歸還原因（可選）"
                    :rows="3">
                </el-input>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="returnDialogVisible = false">取消</el-button>
            <el-button type="primary" @click="submitReturnRequest">確認歸還</el-button>
        </div>
    </el-dialog>

    <div class="tableAround" v-cloak>
        <div class="col-md-12">
            <el-tabs v-model="activeTab" @tab-click="handleTabClick">
                <el-tab-pane label="留樣總覽" name="summary">
                    <el-table
                        ref="sampleTable"
                        :data="summaryDisplayData"
                        border
                        height="600"
                        @selection-change="handleSelectionChange"
                        v-loading="loading"
                        element-loading-text="數據加載中..."
                        :header-cell-style="{background: '#CCDDFF', color: '#333', fontWeight: 'bold'}">

                        <el-table-column type="selection" width="55" align="center"></el-table-column>
                        <el-table-column prop="Project" label="專案名稱" align="center" width="150"></el-table-column>
                        <!-- 修改表格中的專案負責人和留樣人列 -->
                        <el-table-column prop="Owner" label="專案負責人" align="center" width="120">
                            <template slot-scope="scope">
                                <span v-text="getDisplayNameByEmployeeId(scope.row.Owner)"></span>
                            </template>
                        </el-table-column>

                        <el-table-column prop="SampleName" label="樣品名稱" align="center" width="150"></el-table-column>
                        <el-table-column prop="Manufacturer" label="樣品廠商" align="center" width="150"></el-table-column>
                        <el-table-column prop="SampleBatch" label="樣品批次/版本" align="center" width="120"></el-table-column>
                        <el-table-column prop="SampleQuantity" label="留樣數量" align="center" width="100"></el-table-column>
                        <el-table-column prop="Retainer" label="留樣人" align="center" width="100">
                            <template slot-scope="scope">
                                <span v-text="getDisplayNameByEmployeeId(scope.row.Retainer)"></span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="RetainStart" label="留樣日期" align="center" width="120"></el-table-column>
                        <el-table-column prop="RetainPeriod" label="留樣周期(年)" align="center" width="120"></el-table-column>
                        <el-table-column prop="RetainPosition" label="留樣位置" align="center" width="120"></el-table-column>
                        <el-table-column prop="BorrowedQuantity" label="已借出數量" align="center" width="100">
                            <template slot-scope="scope">
                                <span :class="{'status-danger': scope.row.BorrowedQuantity > 0}">
                                    ${ formatNumber(scope.row.BorrowedQuantity) }
                                </span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="RemainedQuantity" label="剩餘留樣數量" align="center" width="120">
                            <template slot-scope="scope">
                                <span :class="{
                                    'status-success': scope.row.RemainedQuantity > 0,
                                    'status-danger': scope.row.RemainedQuantity <= 0
                                }" style="font-weight: bold;">
                                    ${ formatNumber(scope.row.RemainedQuantity) }
                                </span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="UnderApprovalQuantity" label="簽核中數量" align="center" width="100">
                            <template slot-scope="scope">
                                <span :class="{'status-warning': scope.row.UnderApprovalQuantity > 0}">
                                    ${ formatNumber(scope.row.UnderApprovalQuantity) }
                                </span>
                            </template>
                        </el-table-column>
                        <!-- 在留样总览表格中添加操作列 -->
                        <el-table-column label="操作" v-if="isAdmin" align="center" min-width="200" fixed="right">
                            <template slot-scope="scope">
                                <el-button
                                    size="mini"
                                    v-if="isAdmin"
                                    type="primary"
                                    @click="handleEdit(scope.row)">
                                    编辑
                                </el-button>
                                <el-button
                                    size="mini"
                                    v-if="isAdmin"
                                    type="danger"
                                    @click="handleDelete(scope.row)">
                                    删除
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-tab-pane>

                <!-- 修改 myBorrow 标签页的表格 -->
                <el-tab-pane label="我的借用" name="myBorrow">
                    <el-table :data="myBorrows" border height="600" v-loading="loading" @selection-change="handleBorrowSelectionChange">
                        <el-table-column type="selection" width="55" align="center"></el-table-column>
                        <el-table-column prop="SampleName" label="樣品名稱" align="center"></el-table-column>
                        <el-table-column prop="Project" label="專案名稱" align="center"></el-table-column>
                        <el-table-column prop="BorrowQuantity" label="借用數量" align="center"></el-table-column>
                        <el-table-column prop="RemainedQuantity" label="未歸還數量" align="center"></el-table-column>
                        <el-table-column prop="BorrowedReson" label="借用用途" align="center"></el-table-column>
                        <el-table-column prop="Status" label="狀態" align="center" width="120">
                            <template slot-scope="scope">
                                <el-tag :type="getStatusType(scope.row.Status)">
                                    ${ scope.row.Status }
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="created_at" label="申請時間" align="center"></el-table-column>
                        <el-table-column label="操作" align="center" width="180" fixed="right">
                            <template slot-scope="scope">
                                <el-button
                                    v-if="scope.row.Status === '已借用' && scope.row.RemainedQuantity > 0"
                                    size="mini"
                                    type="success"
                                    @click="showReturnDialog(scope.row)">
                                    歸還
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-tab-pane>

                <!-- 修改 myApproval 标签页的表格 -->
                <el-tab-pane label="我的簽核" name="myApproval" v-if="isAdmin">
                    <el-table :data="approvalList" border height="600" v-loading="loading">
                        <el-table-column prop="SampleName" label="樣品名稱" align="center"></el-table-column>
                        <el-table-column prop="Project" label="專案名稱" align="center"></el-table-column>
                        <el-table-column prop="RecordType" label="申請類型" align="center" width="100">
                            <template slot-scope="scope">
                                <el-tag :type="scope.row.RecordType === '借用申請' ? 'primary' : 'success'">
                                    ${ scope.row.RecordType }
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="Borrower" label="申請人" align="center"></el-table-column>
                        <el-table-column prop="Quantity" label="數量" align="center"></el-table-column>
                        <el-table-column prop="Reason" label="原因" align="center"></el-table-column>
                        <el-table-column prop="created_at" label="申請時間" align="center"></el-table-column>
                        <el-table-column label="操作" align="center" width="200" fixed="right">
                            <template slot-scope="scope">
                                <el-button
                                    v-if="scope.row.Status === '待审批' || scope.row.Status === '待确认'"
                                    size="mini"
                                    type="success"
                                    @click="handleApprove(scope.row)">
                                    同意
                                </el-button>
                                <el-button
                                    v-if="scope.row.Status === '待审批' || scope.row.Status === '待确认'"
                                    size="mini"
                                    type="danger"
                                    @click="handleReject(scope.row)">
                                    拒絕
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-tab-pane>

                <el-tab-pane label="借還記錄" name="records">
                    <el-table :data="recordsDisplayData" border height="600" v-loading="loading">
                        <el-table-column prop="SampleName" label="樣品名稱" align="center"></el-table-column>
                        <el-table-column prop="Project" label="專案名稱" align="center"></el-table-column>
                        <el-table-column prop="Manufacturer" label="樣品廠商" align="center"></el-table-column>
                        <el-table-column prop="Borrower" label="借用人" align="center"></el-table-column>
                        <el-table-column prop="BorrowQuantity" label="借用數量" align="center"></el-table-column>
                        <el-table-column prop="BorrowedReson" label="借用用途" align="center"></el-table-column>
                        <el-table-column prop="BorrowedStatus" label="借用狀態" align="center"></el-table-column>
                        <el-table-column prop="ReturnedStatus" label="歸還狀態" align="center"></el-table-column>
                        <el-table-column prop="created_at" label="申請時間" align="center"></el-table-column>
                    </el-table>
                </el-tab-pane>

                <el-tab-pane label="報廢記錄" name="scrapRecords" v-if="isAdmin">
                    <el-table :data="scrapRecordsDisplayData" border height="600" v-loading="loading">
                        <el-table-column prop="SampleName" label="樣品名稱" align="center"></el-table-column>
                        <el-table-column prop="Project" label="專案名稱" align="center"></el-table-column>
                        <el-table-column prop="Manufacturer" label="樣品廠商" align="center"></el-table-column>
                        <el-table-column prop="ScrappedBy" label="報廢人" align="center"></el-table-column>
                        <el-table-column prop="ScrapQuantity" label="報廢數量" align="center"></el-table-column>
                        <el-table-column prop="ScrapReason" label="報廢原因" align="center"></el-table-column>
                        <el-table-column prop="created_at" label="報廢時間" align="center"></el-table-column>
                    </el-table>
                </el-tab-pane>
            </el-tabs>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="/static/js/es6/polyfill.min.js"></script>
<script src="/static/js/es6/babel.min.js"></script>
<script src="/static/js/axios.min.js"></script>
<script src="/static/js/vue.min.js"></script>
<script src="/static/js/qs.js"></script>
<script src="/static/js/Element/index.js"></script>
<script type="text/babel">
new Vue({
    el: '#app',
    delimiters: ['${', '}'],
    data: function() {
        return {
            currentTime: new Date().toLocaleString('zh-TW'),
            activeTab: 'summary',
            loading: false,
            isAdmin: false,

            // 当前登录用户信息
            currentUser: null,

            // 搜索条件 - 按标签页分开
            searchConditions: {
                summary: {
                    project: '',
                    sample: '',
                    manufacturer: ''
                },
                records: {
                    project: '',
                    sample: '',
                    manufacturer: '',
                    borrower: ''
                },
                scrapRecords: {
                    project: '',
                    sample: '',
                    manufacturer: ''
                }
            },

            // 下拉选项数据
            filterOptions: {
                summary: {
                    projects: [],
                    samples: [],
                    manufacturers: [],
                    users: [],  // 用户选项数组，格式：[{value: '工号', label: '姓名（工号）'}]
                    retain_positions: []
                },
                records: {
                    projects: [],
                    samples: [],
                    manufacturers: [],
                    borrowers: []
                },
                scrapRecords: {
                    projects: [],
                    samples: [],
                    manufacturers: []
                }
            },

            // 过滤后的用户列表（用于下拉搜索）
            filteredUsers: [],

            // 选中的用户显示名称
            selectedOwnerDisplay: '',
            selectedRetainerDisplay: '',

            // 显示数据
            summaryDisplayData: [],
            myBorrows: [],
            approvalList: [],
            recordsDisplayData: [],
            scrapRecordsDisplayData: [],

            // 对话框控制
            addDialogVisible: false,
            borrowDialogVisible: false,
            scrapDialogVisible: false,

            // 当前选中的样品
            selectedSample: null,

            // 对话框控制（合并新增和编辑）
            isEditMode: false,
            currentEditId: null,

            // 归还相关
            returnDialogVisible: false,
            returnDialogTitle: '申請歸還',
            returnForm: {
                ReturnQuantity: 1,
                ReturnReason: ''
            },
            selectedBorrowRecord: null,
            selectedBorrowRecords: [],

            // 表单数据
            addForm: {
                Key_Post: '',
                Project: '',
                Owner: '',  // 保存工号
                SampleName: '',
                Manufacturer: '',
                SampleBatch: '',
                SampleQuantity: 1,
                Retainer: '',  // 保存工号
                RetainStart: this.formatDate(new Date()),
                RetainPeriod: 1,
                RetainPosition: 'Plant5-#23'
            },

            borrowForm: {
                BorrowQuantity: 1,
                BorrowedReson: '质量追溯',
                OtherReason: ''
            },

            scrapForm: {
                ScrapQuantity: 1,
                ScrapReason: ''
            },

            selectedSamples: [],

            // 添加表单验证规则
            addFormRules: {
                Project: [
                    { required: true, message: '请输入專案名稱', trigger: 'blur' }
                ],
                Owner: [
                    { required: true, message: '请选择專案負責人', trigger: 'change' }
                ],
                SampleName: [
                    { required: true, message: '请输入樣品名稱', trigger: 'blur' }
                ],
                Manufacturer: [
                    { required: true, message: '请输入樣品廠商', trigger: 'blur' }
                ],
                SampleBatch: [
                    { required: true, message: '请输入樣品批次/版本號', trigger: 'blur' }
                ],
                Retainer: [
                    { required: true, message: '请选择留樣人', trigger: 'change' }
                ],
                RetainStart: [
                    { required: true, message: '请选择留樣日期', trigger: 'change' }
                ],
                RetainPosition: [
                    { required: true, message: '请选择留樣位置', trigger: 'change' }
                ]
            },
        }
    },
    mounted() {
        // 初始加载 summary 数据
        this.loadTabData('summary');
        // 更新当前时间
        setInterval(() => {
            this.currentTime = new Date().toLocaleString('zh-TW');
        }, 1000);
    },
    methods: {
        // 格式化日期为 YYYY-MM-DD
        formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        },

        // 过滤用户列表
        filterUsers(query) {
            if (query) {
                this.filteredUsers = this.filterOptions.summary.users.filter(user => {
                    return user.label.toLowerCase().includes(query.toLowerCase()) ||
                           user.value.toLowerCase().includes(query.toLowerCase());
                });
            } else {
                this.filteredUsers = this.filterOptions.summary.users;
            }
        },

        // 处理负责人选择变化
        handleOwnerChange(value) {
            const selectedUser = this.filterOptions.summary.users.find(user => user.value === value);
            this.selectedOwnerDisplay = selectedUser ? selectedUser.label : '';
        },

        // 处理留样人选择变化
        handleRetainerChange(value) {
            const selectedUser = this.filterOptions.summary.users.find(user => user.value === value);
            this.selectedRetainerDisplay = selectedUser ? selectedUser.label : '';
        },

        // 根据工号获取显示名称
        getDisplayNameByEmployeeId(employeeId) {
            if (!employeeId) return '';
            const user = this.filterOptions.summary.users.find(u => u.value === employeeId);
            return user ? user.label : employeeId;
        },

        // 显示新增对话框
        showAddDialog() {
            this.isEditMode = false;
            this.currentEditId = null;
            this.resetAddForm();

            // 设置留样日期为当天
            this.addForm.RetainStart = this.formatDate(new Date());

            // 设置留样人为当前登录用户（默认选中）
            if (this.currentUser && this.currentUser.value) {
                this.addForm.Retainer = this.currentUser.value;
                this.selectedRetainerDisplay = this.currentUser.display_name;

                // 确保当前用户在下拉选项中
                this.ensureUserInList(this.currentUser.value, this.currentUser.display_name);
            }

            // 初始化用户列表
            this.filteredUsers = this.filterOptions.summary.users;

            // 使用$nextTick确保DOM更新后再打开对话框
            this.$nextTick(() => {
                this.addDialogVisible = true;
            });
        },

        // 编辑留样
        handleEdit(row) {
            this.isEditMode = true;
            this.currentEditId = row.id;

            // 将当前行的数据复制到表单中
            this.addForm = {
                Key_Post: '',
                Project: row.Project,
                Owner: row.Owner,
                SampleName: row.SampleName,
                Manufacturer: row.Manufacturer,
                SampleBatch: row.SampleBatch,
                SampleQuantity: row.SampleQuantity,
                Retainer: row.Retainer,
                RetainStart: row.RetainStart,
                RetainPeriod: row.RetainPeriod,
                RetainPosition: row.RetainPosition
            };

            // 确保负责人和留样人都在用户列表中
            if (row.Owner) {
                const ownerDisplay = this.getDisplayNameByEmployeeId(row.Owner);
                this.ensureUserInList(row.Owner, ownerDisplay || row.Owner);
                this.selectedOwnerDisplay = ownerDisplay;
            }

            if (row.Retainer) {
                const retainerDisplay = this.getDisplayNameByEmployeeId(row.Retainer);
                this.ensureUserInList(row.Retainer, retainerDisplay || row.Retainer);
                this.selectedRetainerDisplay = retainerDisplay;
            }

            // 初始化用户列表
            this.filteredUsers = this.filterOptions.summary.users;

            // 使用$nextTick确保DOM更新后再打开对话框
            this.$nextTick(() => {
                this.addDialogVisible = true;
            });
        },

        // 确保用户在下拉列表中
        ensureUserInList(userValue, userLabel) {
            if (!userValue) return;

            const userExists = this.filterOptions.summary.users.some(
                user => user.value === userValue
            );

            if (!userExists) {
                this.filterOptions.summary.users.unshift({
                    value: userValue,
                    label: userLabel
                });
            }
        },

        // 保存留样（新增或编辑）
        saveRetainedSample() {
            // 表单验证
            if (!this.addForm.Project || this.addForm.Project.trim() === '') {
                this.$message.warning('请输入專案名稱');
                return;
            }
            if (!this.addForm.SampleName || this.addForm.SampleName.trim() === '') {
                this.$message.warning('请输入樣品名稱');
                return;
            }
            if (!this.addForm.Manufacturer || this.addForm.Manufacturer.trim() === '') {
                this.$message.warning('请输入樣品名稱');
                return;
            }
            if (!this.addForm.SampleBatch || this.addForm.SampleBatch.trim() === '') {
                this.$message.warning('请输入樣品批次/版本號');
                return;
            }
            if (!this.addForm.Owner || this.addForm.Owner.trim() === '') {
                this.$message.warning('请选择專案負責人');
                return;
            }
            if (!this.addForm.Retainer || this.addForm.Retainer.trim() === '') {
                this.$message.warning('请选择留樣人');
                return;
            }
            if (!this.addForm.RetainStart) {
                this.$message.warning('请选择留樣日期');
                return;
            }
            if (!this.addForm.RetainPosition || this.addForm.RetainPosition.trim() === '') {
                this.$message.warning('请选择留樣位置');
                return;
            }

            this.loading = true;

            // 根据模式设置不同的Key_Post值
            const formData = {
                ...this.addForm,
                Key_Post: this.isEditMode ? 'editdata' : 'adddata'
            };

            // 如果是编辑模式，添加ID
            if (this.isEditMode) {
                formData.id = this.currentEditId;
            }

            axios.post('/RetainedSample/RetainedSample_summary/', formData)
                .then(response => {
                    this.loading = false;
                    const data = response.data;
                    if (data.success) {
                        const message = this.isEditMode ? '更新成功' : '添加成功';
                        this.$message.success(message);
                        this.addDialogVisible = false;
                        // 重新加载summary数据
                        this.loadTabData('summary');
                        this.resetAddForm();
                    } else {
                        this.$message.error(data.message || '操作失败');
                    }
                })
                .catch(error => {
                    this.loading = false;
                    console.error('操作失败:', error);
                    this.$message.error('操作失败');
                });
        },

        // 删除留样
        handleDelete(row) {
            this.$confirm('确认删除这条留样记录吗？删除后无法恢复。', '提示', {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
            }).then(() => {
                this.loading = true;

                const deleteData = {
                    Key_Post: 'deletedata',
                    id: row.id
                };

                axios.post('/RetainedSample/RetainedSample_summary/', deleteData)
                    .then(response => {
                        this.loading = false;
                        const data = response.data;
                        if (data.success) {
                            this.$message.success('删除成功');
                            // 重新加载数据
                            this.loadTabData('summary');
                        } else {
                            this.$message.error(data.message || '删除失败');
                        }
                    })
                    .catch(error => {
                        this.loading = false;
                        console.error('删除失败:', error);
                        this.$message.error('删除失败');
                    });
            }).catch(() => {
                // 用户取消删除
            });
        },

        resetAddForm() {
            this.addForm = {
                Key_Post: '',
                Project: '',
                Owner: '',
                SampleName: '',
                Manufacturer: '',
                SampleBatch: '',
                SampleQuantity: 1,
                Retainer: '',
                RetainStart: this.formatDate(new Date()),
                RetainPeriod: 1,
                RetainPosition: 'Plant5-#23'
            };
            this.selectedOwnerDisplay = '';
            this.selectedRetainerDisplay = '';
        },

        // 根据标签页加载数据
        loadTabData(tab) {
            this.loading = true;

            // 根据不同的标签页构造不同的参数
            let params = { tab: tab };

            // 添加搜索条件到参数中（如果有的话）
            switch(tab) {
                case 'summary':
                    if (this.searchConditions.summary.project) params.project = this.searchConditions.summary.project;
                    if (this.searchConditions.summary.sample) params.sample = this.searchConditions.summary.sample;
                    if (this.searchConditions.summary.manufacturer) params.manufacturer = this.searchConditions.summary.manufacturer;
                    break;
                case 'records':
                    if (this.searchConditions.records.project) params.project = this.searchConditions.records.project;
                    if (this.searchConditions.records.sample) params.sample = this.searchConditions.records.sample;
                    if (this.searchConditions.records.manufacturer) params.manufacturer = this.searchConditions.records.manufacturer;
                    if (this.searchConditions.records.borrower) params.borrower = this.searchConditions.records.borrower;
                    break;
                case 'scrapRecords':
                    if (this.searchConditions.scrapRecords.project) params.project = this.searchConditions.scrapRecords.project;
                    if (this.searchConditions.scrapRecords.sample) params.sample = this.searchConditions.scrapRecords.sample;
                    if (this.searchConditions.scrapRecords.manufacturer) params.manufacturer = this.searchConditions.scrapRecords.manufacturer;
                    break;
                case 'myBorrow':
                case 'myApproval':
                    // 这些标签页没有搜索条件
                    break;
            }

            axios.get('/RetainedSample/RetainedSample_summary/', { params: params })
                .then(response => {
                    const data = response.data;
                    if (data.success) {
                        this.isAdmin = data.is_admin || false;

                        if (this.isAdmin) {
                            document.body.classList.add('is-admin');
                        }

                        // 根据标签页处理数据
                        switch(tab) {
                            case 'summary':
                                this.summaryDisplayData = data.samples || [];

                                // 更新下拉选项
                                if (data.filter_options) {
                                    this.filterOptions.summary.projects = data.filter_options.projects || [];
                                    this.filterOptions.summary.samples = data.filter_options.samples || [];
                                    this.filterOptions.summary.manufacturers = data.filter_options.manufacturers || [];
                                    this.filterOptions.summary.users = data.filter_options.users || [];
                                    this.filterOptions.summary.retain_positions = data.filter_options.retain_positions || [];
                                }

                                // 保存当前用户信息
                                if (data.current_user) {
                                    this.currentUser = data.current_user;

                                    // 确保当前用户在下拉选项中
                                    this.ensureUserInList(this.currentUser.value, this.currentUser.display_name);
                                }

                                // 初始化用户列表
                                this.filteredUsers = this.filterOptions.summary.users;
                                break;
                            case 'myBorrow':
                                this.myBorrows = data.my_borrows || [];
                                break;
                            case 'myApproval':
                                this.approvalList = data.approval_list || [];
                                break;
                            case 'records':
                                this.recordsDisplayData = data.borrow_records || [];
                                // 更新下拉选项
                                if (data.filter_options) {
                                    this.filterOptions.records.projects = data.filter_options.projects || [];
                                    this.filterOptions.records.samples = data.filter_options.samples || [];
                                    this.filterOptions.records.manufacturers = data.filter_options.manufacturers || [];
                                    this.filterOptions.records.borrowers = data.filter_options.borrowers || [];
                                }
                                break;
                            case 'scrapRecords':
                                this.scrapRecordsDisplayData = data.scrap_records || [];
                                // 更新下拉选项
                                if (data.filter_options) {
                                    this.filterOptions.scrapRecords.projects = data.filter_options.projects || [];
                                    this.filterOptions.scrapRecords.samples = data.filter_options.samples || [];
                                    this.filterOptions.scrapRecords.manufacturers = data.filter_options.manufacturers || [];
                                }
                                break;
                        }
                        this.loading = false;
                    } else {
                        // 如果是报废记录且返回失败，可能是后端没有实现这个接口
                        if (tab === 'scrapRecords') {
                            this.scrapRecordsDisplayData = [];
                            this.$message.warning('暫無報廢記錄數據');
                        } else {
                            this.$message.error(data.message || '加载数据失败');
                        }
                        this.loading = false;
                    }
                })
                .catch(error => {
                    console.error('加载数据失败:', error);
                    if (tab === 'scrapRecords') {
                        this.scrapRecordsDisplayData = [];
                        this.$message.warning('暫無報廢記錄數據');
                    } else {
                        this.$message.error('加载数据失败');
                    }
                    this.loading = false;
                });
        },

        handleTabClick(tab) {
            this.activeTab = tab.name;
            this.loadTabData(tab.name);
        },

        // 搜索方法 - 重新加载当前标签页的数据
        handleSearch() {
            this.loadTabData(this.activeTab);
        },

        // 重置搜索
        handleReset() {
            switch(this.activeTab) {
                case 'summary':
                    this.searchConditions.summary = {
                        project: '',
                        sample: '',
                        manufacturer: ''
                    };
                    this.loadTabData('summary');
                    break;
                case 'records':
                    this.searchConditions.records = {
                        project: '',
                        sample: '',
                        manufacturer: '',
                        borrower: ''
                    };
                    this.loadTabData('records');
                    break;
                case 'scrapRecords':
                    this.searchConditions.scrapRecords = {
                        project: '',
                        sample: '',
                        manufacturer: ''
                    };
                    this.loadTabData('scrapRecords');
                    break;
            }
        },

        handleSelectionChange(selection) {
            this.selectedSamples = selection;
            this.selectedSample = selection.length > 0 ? selection[0] : null;
        },

        showBorrowDialog() {
            if (this.selectedSamples.length === 0) {
                this.$message.warning('请选择要借用的样品');
                return;
            }
            if (this.selectedSamples.length > 1) {
                this.$message.warning('一次只能借用一种样品');
                return;
            }

            const sample = this.selectedSamples[0];
            if (sample.RemainedQuantity <= 0) {
                this.$message.error('该样品已无库存');
                return;
            }

            this.borrowForm.BorrowQuantity = 1;
            this.borrowDialogVisible = true;
        },

        showScrapDialog() {
            if (this.selectedSamples.length === 0) {
                this.$message.warning('请选择要报废的样品');
                return;
            }
            if (this.selectedSamples.length > 1) {
                this.$message.warning('一次只能报废一种样品');
                return;
            }

            const sample = this.selectedSamples[0];
            if (sample.RemainedQuantity <= 0) {
                this.$message.error('该样品已无库存');
                return;
            }

            this.scrapForm.ScrapQuantity = 1;
            this.scrapDialogVisible = true;
        },

        borrowSample() {
            if (this.selectedSamples.length === 0) return;

            const borrowData = {
                borrowData: 'borrowData',
                sample_id: this.selectedSamples[0].id,
                borrow_quantity: this.borrowForm.BorrowQuantity,
                borrow_reason: this.borrowForm.BorrowedReson === '其他' ?
                    this.borrowForm.OtherReason : this.borrowForm.BorrowedReson
            };

            this.loading = true;
            axios.post('/RetainedSample/RetainedSample_summary/', borrowData)
                .then(response => {
                    this.loading = false;
                    const data = response.data;
                    if (data.success) {
                        this.$message.success('借用申请提交成功，等待管理员审核');
                        this.borrowDialogVisible = false;
                        // 重新加载相关标签页数据
                        this.loadTabData('summary');
                        this.loadTabData('myBorrow');
                        this.resetBorrowForm();
                        this.selectedSamples = [];
                        this.selectedSample = null;
                    } else {
                        this.$message.error(data.message || '借用失败');
                    }
                })
                .catch(error => {
                    this.loading = false;
                    console.error('借用失败:', error);
                    this.$message.error('借用失败');
                });
        },

        scrapSample() {
            if (this.selectedSamples.length === 0) return;

            const scrapData = {
                scrapData: 'scrapData',
                sample_id: this.selectedSamples[0].id,
                scrap_quantity: this.scrapForm.ScrapQuantity,
                scrap_reason: this.scrapForm.ScrapReason
            };

            this.loading = true;
            axios.post('/RetainedSample/RetainedSample_summary/', scrapData)
                .then(response => {
                    this.loading = false;
                    const data = response.data;
                    if (data.success) {
                        this.$message.success('报废成功');
                        this.scrapDialogVisible = false;
                        // 重新加载相关标签页数据
                        this.loadTabData('summary');
                        this.loadTabData('scrapRecords');
                        this.resetScrapForm();
                        this.selectedSamples = [];
                        this.selectedSample = null;
                    } else {
                        this.$message.error(data.message || '报废失败');
                    }
                })
                .catch(error => {
                    this.loading = false;
                    console.error('报废失败:', error);
                    this.$message.error('报废失败');
                });
        },

        approveBorrow(record) {
            this.$confirm('确认同意借用申请吗?', '提示', {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
            }).then(() => {
                this.loading = true;
                axios.post('/RetainedSample/RetainedSample_summary/', { record_id: record.id, scrapData: 'scrapData' })
                    .then(response => {
                        this.loading = false;
                        const data = response.data;
                        if (data.success) {
                            this.$message.success('审核通过');
                            this.loadTabData('myApproval');
                            this.loadTabData('records');
                        } else {
                            this.$message.error(data.message || '审核失败');
                        }
                    })
                    .catch(error => {
                        this.loading = false;
                        console.error('审核失败:', error);
                        this.$message.error('审核失败');
                    });
            });
        },

        rejectBorrow(record) {
            this.$confirm('确认拒绝借用申请吗?', '提示', {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
            }).then(() => {
                this.loading = true;
                axios.post('/RetainedSample/RetainedSample_summary/', { record_id: record.id, reject: 'reject' })
                    .then(response => {
                        this.loading = false;
                        const data = response.data;
                        if (data.success) {
                            this.$message.success('已拒绝');
                            this.loadTabData('myApproval');
                            this.loadTabData('records');
                        } else {
                            this.$message.error(data.message || '操作失败');
                        }
                    })
                    .catch(error => {
                        this.loading = false;
                        console.error('操作失败:', error);
                        this.$message.error('操作失败');
                    });
            });
        },

        getStatusType(status) {
            const typeMap = {
                '借用確認中': 'warning',
                '已借用': 'success',
                '歸還確認中': 'info',
                '已歸還': 'primary',
                '已拒絕': 'danger',
                '歸還確認中': 'warning'  // 添加归还确认中的状态
            };
            return typeMap[status] || 'info';
        },

        resetBorrowForm() {
            this.borrowForm = {
                BorrowQuantity: 1,
                BorrowedReson: '质量追溯',
                OtherReason: ''
            };
        },

        resetScrapForm() {
            this.scrapForm = {
                ScrapQuantity: 1,
                ScrapReason: ''
            };
        },

        // 处理我的借用表格的选择
        handleBorrowSelectionChange(selection) {
            this.selectedBorrowRecords = selection;
            this.selectedBorrowRecord = selection.length > 0 ? selection[0] : null;
        },

        // 显示归还对话框
        showReturnDialog(record) {
            if (record.Status !== '已借用') {
                this.$message.warning('只有已借用的樣品可以歸還');
                return;
            }

            if (record.RemainedQuantity <= 0) {
                this.$message.warning('該樣品已無需歸還數量');
                return;
            }

            this.selectedBorrowRecord = record;
            this.returnForm.ReturnQuantity = record.RemainedQuantity;
            this.returnForm.ReturnReason = '';
            this.returnDialogTitle = `歸還樣品：${record.SampleName}`;
            this.returnDialogVisible = true;
        },

        // 提交归还申请
        submitReturnRequest() {
            if (!this.selectedBorrowRecord) {
                this.$message.warning('請選擇要歸還的記錄');
                return;
            }

            if (this.returnForm.ReturnQuantity <= 0) {
                this.$message.warning('歸還數量必須大於0');
                return;
            }

            if (this.returnForm.ReturnQuantity > this.selectedBorrowRecord.RemainedQuantity) {
                this.$message.warning('歸還數量不能超過未歸還數量');
                return;
            }

            this.loading = true;

            const returnData = {
                action_type: 'request_return',
                record_id: this.selectedBorrowRecord.id,
                return_quantity: this.returnForm.ReturnQuantity,
                return_reason: this.returnForm.ReturnReason || '正常歸還'
            };

            axios.post('/RetainedSample/handle_return/', returnData)
                .then(response => {
                    this.loading = false;
                    const data = response.data;
                    if (data.success) {
                        this.$message.success('歸還申請提交成功，等待管理員確認');
                        this.returnDialogVisible = false;
                        // 重新加载数据
                        this.loadTabData('myBorrow');
                        this.resetReturnForm();
                    } else {
                        this.$message.error(data.message || '歸還申請失敗');
                    }
                })
                .catch(error => {
                    this.loading = false;
                    console.error('歸還申請失敗:', error);
                    this.$message.error('歸還申請失敗');
                });
        },

        // 同意审批
        handleApprove(record) {
            this.$confirm(`確定要${record.RecordType === '歸還申請' ? '同意歸還' : '同意借用'}嗎?`, '提示', {
                confirmButtonText: '確定',
                cancelButtonText: '取消',
                type: 'warning'
            }).then(() => {
                this.loading = true;

                const approveData = {
                    action_type: 'confirm_approval',
                    record_id: record.id,
                    record_type: record.RecordType,
                    confirm_quantity: record.Quantity
                };

                axios.post('/RetainedSample/handle_approval/', approveData)
                    .then(response => {
                        this.loading = false;
                        const data = response.data;
                        //console.log(data);
                        if (data.success) {
                            this.$message.success('操作成功');
                            // 重新加载相关标签页数据
                            this.loadTabData('myApproval');
                            this.loadTabData('summary');
                            this.loadTabData('records');
                        } else {
                            this.$message.error(data.message || '操作失敗');
                        }
                    })
                    .catch(error => {
                        this.loading = false;
                        console.error('操作失敗:', error);
                        this.$message.error('操作失敗');
                    });
            });
        },

        // 拒绝审批
        handleReject(record) {
            this.$prompt('請輸入拒絕原因', '提示', {
                confirmButtonText: '確定',
                cancelButtonText: '取消',
                inputPattern: /.+/,
                inputErrorMessage: '請輸入拒絕原因'
            }).then(({ value }) => {
                this.loading = true;

                const rejectData = {
                    action_type: 'reject_approval',
                    record_id: record.id,
                    record_type: record.RecordType,
                    reject_reason: value
                };

                axios.post('/RetainedSample/handle_approval/', rejectData)
                    .then(response => {
                        this.loading = false;
                        const data = response.data;
                        console.log(data);
                        if (data.success) {
                            this.$message.success('操作成功');
                            // 重新加载相关标签页数据
                            this.loadTabData('myApproval');
                            this.loadTabData('summary');
                        } else {
                            this.$message.error(data.message || '操作失敗');
                        }
                    })
                    .catch(error => {
                        this.loading = false;
                        console.error('操作失敗:', error);
                        this.$message.error('操作失敗');
                    });
            }).catch(() => {
                // 用户取消
            });
        },

        // 重置归还表单
        resetReturnForm() {
            this.returnForm = {
                ReturnQuantity: 1,
                ReturnReason: ''
            };
            this.selectedBorrowRecord = null;
        },
        // 格式化数字显示，去除空格和换行
        formatNumber(value) {
            if (value === null || value === undefined) return '0';
            return String(value).trim().replace(/\n/g, '');
        },
    }
});
</script>
{% endblock %}